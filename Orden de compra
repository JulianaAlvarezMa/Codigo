//grupos.js
ActualizarCantidadesOrde

ActualizarCantidadesOrden(cantidad_actualizada, data, element, idTabla) {
    console.log("data", data);

    const form = new FormFormat();
    const tabla = $(element).closest('table');
    const fila = $(element).closest('tr');

    const costoUnitario = parseFloat(data.costo.replace(/[^0-9,]/g, '').replace(',', '.'));
    const factor = parseFloat((data.fact_conversion || '1').toString().replace(/\./g, '').replace(',', '.'));
    const descripcion = data.descripcion;
    const producto = parseFloat((data.producto || '').toString().replace(/\./g, '').replace(',', '.'));
    const cant_sugerida = parseFloat(((cantidad_actualizada) || '0').toString().replace(/\./g, '').replace(',', '.'));
    const cantidadNumerica = parseFloat(cantidad_actualizada.toString().replace(/\./g, '').replace(',', '.'));
    const cantSugeridaNum  = parseFloat(data.cant_sugerida.toString().replace(/\./g, '').replace(',', '.'));

    // Solo validar sugerida si es la tabla específica
    
    if (!isNaN(data.cant_sugerida)) {
        if (idTabla === "datatable-ordenSugerida") {
            if ( cantidadNumerica !== cantSugeridaNum) {
                console.log("La cantidad sugerida es numérica y diferente a la cantidad.");
                fila.find("td#tipo_concepto_detalle select").attr("required", true);
                fila.find("td#tipo_concepto_detalle select").attr("disabled", false);
                fila.find("td#tipo_concepto_detalle select").val('').trigger('chosen:updated');
                fila.find("#tipo_orden_detalle").text("MANUAL");
            } else {
                fila.find("td#tipo_concepto_detalle select").attr("required", false);
                fila.find("td#tipo_concepto_detalle select").attr("disabled", true);

                fila.find("td#tipo_concepto_detalle select").val('').trigger('chosen:updated');
                fila.find("#tipo_orden_detalle").text("SUGERIDO");
            }
        }
    }else{
        console.log("NO ES SUGERIDO");
    }

    // Validación general de cantidad
    if (isNaN(cantidadNumerica) || isNaN(costoUnitario) || cantidadNumerica <= 0) {
        swal("Error", "La cantidad solicitada debe ser un número mayor a cero.", "warning");
        fila.find("#cantidad_solicitada").val(cant_sugerida !== '0' ? cant_sugerida : '0');
    } else {
        fila.find('#cantidad_solicitada').val(cantidadNumerica);
    }

    // Calcular total
    console.log("descripcion")
    console.log(descripcion)
    const total = cantidadNumerica * costoUnitario;
    console.log("aca 1.2")
    const cajasCalculadas = this.calcularCajas(cantidadNumerica, factor, descripcion);

    fila.find('#cajas').text(cajasCalculadas);
    fila.find('#valor_total').text(form.formatMoney(total, 0));

    // Recalcular totales de la orden
    const Orden = this.CalculosOrdenCompra('#' + idTabla);
    const totalOrden = Orden.productos.reduce((acc, fila) => {
        const valor = parseFloat(fila.valor_total);
        return acc + (isNaN(valor) ? 0 : valor);
    }, 0);

    this.calculosTotalesOrdenCompra(totalOrden, form);
}




events.js

$(document).on('change', '#tercero_id', function (e) {
            e.preventDefault();
            const proveedor = $(this).val(); 
            orden.ProductosProveedor(proveedor);
        });


tercero.js
 ProductosProveedor(idproveedor) {
        const subProveedores = this.subProveedores.filter(item => item.idtercero === idproveedor);
        const productos_proveedor = this.optionProducto.filter(item => item.params && item.params.tercero_id === idproveedor.toString());

        const form = new FormFormat();
        const $form = $('#orden-compra');

        // Referencia al campo del proveedor
        const $campoProveedor = $form.find('#tercero_id').closest('.form-group');

        const $subSelect = $form.find('#tercero_siesa_id').closest('.form-group');
        if ($subSelect.length) {
            $subSelect.slideUp(200, () => $subSelect.remove());
        }


        if (subProveedores.length > 0) {
            const $selectSubproveedor = $(form.agregarSelect({
                id: 'tercero_siesa_id',
                name: 'tercero_siesa_id',
                options: subProveedores ||[],
                placeholder: 'Sub proveedor',
                required: true,
                classDivName: 'col-lg-4 col-md-4 col-sm-12',
                conContenedor: true,
                conLabel: true,
            })).hide();

            // Insertar justo después del campo del proveedor
            $campoProveedor.after($selectSubproveedor);
            $selectSubproveedor.slideDown(300, () => {
                form.formatSelect(); // Aplica Chosen u otros formatos
            $("#orden-compra #compra_mes").val(form.formatMoney(0));
            $("#orden-compra #convenio_mensual").val(form.formatMoney(0));
            $("#orden-compra #orden_min_compra").val(form.formatMoney(0));
            });
            
        }else {
            this.controler = 'ordenCompra/';
            this.controlador('CompraMesTercero', {id_tercero:idproveedor}, 'POST')
                .then((r) => {
                    const { response, message, data } = r;

                    console.log('Productos del proveedor', data);
                    if (response) {
                    
                        $("#orden-compra #compra_mes").val(form.formatMoney(data[0].valor_total_compras || 0));
                        $("#orden-compra #convenio_mensual").val(form.formatMoney(data[0].valor_convenio || 0));
                        $("#orden-compra #orden_min_compra").val(form.formatMoney(data[0].valor_minimo || 0));
                    }
                    else {
                    $("#orden-compra #compra_mes").val(form.formatMoney(0));
                    $("#orden-compra #convenio_mensual").val(form.formatMoney(0));
                    $("#orden-compra #orden_min_compra").val(form.formatMoney(0));
                    }

                }).catch((e) => {
                    console.error('Error al obtener los convenios proveedor', e);
                }); 
        
        
        }
        
        const $selectProductoAnterior = $form.find('#productos').closest('.form-group');
        if ($selectProductoAnterior.length) {
            $selectProductoAnterior.slideUp(200, () => $selectProductoAnterior.remove());
        }

        const $campoConvenio = $form.find('#tipo_concepto').closest('.form-group');

        const $selectProducto = $(form.agregarSelect({
            id: 'productos',
            name: 'productos',
            options: productos_proveedor,
            placeholder: 'Productos',
            required: false,
            classDivName: 'col-lg-12 col-md-12 col-sm-12',
            conContenedor: true,
            conLabel: true,
        })).hide();

        $campoConvenio.after($selectProducto);
        $selectProducto.slideDown(300, () => {
            form.formatSelect();
        });
    }
