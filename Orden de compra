//Events.js:
$(document)
    .off('blur', '#valida_fecha_llegada_minima,#valida_fecha_llegada_maxima')
    .on('blur', '#valida_fecha_llegada_minima, #valida_fecha_llegada_maxima', function (e) {
        if (!e.originalEvent?.isTrusted) {
            return;
        }
        const destino = e.relatedTarget;
        if (destino && $(destino).closest('.chosen-container').length) {
            return;
        }

        const $form = $(this).closest('#orden-compra');

        const fecha_llegada_minima = $form.find('#valida_fecha_llegada_minima').val();
        const fecha_llegada_maxima = $form.find('#valida_fecha_llegada_maxima').val();

        if (fecha_llegada_minima && fecha_llegada_maxima) {
            const form = new FormFormat();
            const validarFecha = form.validarFecha(fecha_llegada_minima, fecha_llegada_maxima);

            if (!validarFecha) {
                swal("Error", "La fecha mínima de llegada no puede ser mayor a la fecha máxima de llegada.", "error");
                $form.find('#fecha_llegada_minima').val("");
                return false;
            }
        }
    });




$(document).on('change', '#fecha_llegada_minima', function (e) {
            const $form = $(this).closest('#orden-compra');
            const fecha_llegada_minima = $form.find('#fecha_llegada_minima').val();
            const fecha_llegada_maxima = $form.find('#fecha_llegada_maxima').val();
            const estado = $("#estcom_b").val(); 
            // console.log(idtercero);
            orden.AplicarObservacionNueva(fecha_llegada_minima,estado);
           
            console.log("Cambio detectado en fechas:", fecha_llegada_minima, fecha_llegada_maxima);

            if (fecha_llegada_minima && fecha_llegada_maxima) {
                const form = new FormFormat();
                const validarFecha = form.validarFecha(fecha_llegada_minima, fecha_llegada_maxima);

                if (!validarFecha) {
                    swal("Error","La fecha mínima de llegada no puede ser mayor a la fecha máxima de llegada.","error");
                    $form.find('#fecha_llegada_minima').val("");
                    return false;
                }
            }
        });

//tercero.js: 

AplicarObservacionNueva(fecha_minima_nueva, estado) {
    // console.log('AplicarObservacionNueva', fecha_minima_nueva, estado);

    const $form = $('#orden-compra'); // Asegura contexto
    const $observacionExistente = $form.find('#observacion');

    if (estado === 'EN TRANSITO') {
        if ($observacionExistente.length === 0) {
            const form = new FormFormat();
            const $inputObservacion = $(form.agregarInput({
                id: 'observacion',
                name: 'observacion',
                placeholder: 'Motivo de Reprogramación',
                required: true,
                classDivName: 'col-lg-6 col-md-6 col-sm-12 col-md-12',
                conContenedor: true,
                conLabel: true,
            })).hide();

            const $campo = $form.find('#num_factura').closest('.form-group');
            $inputObservacion.insertAfter($campo).slideDown(300);
        }
    } else {
        if ($observacionExistente.length) {
            $observacionExistente.closest('.form-group').slideUp(300, function () {
                $(this).remove();
            });
        }
    }

    
}

//events.js: 
$(document).on('change', '#tercero_id', function (e) {
            e.preventDefault();
            const proveedor = $(this).val(); 
            orden.ProductosProveedor(proveedor);
        });

//tercero.js: 
ProductosProveedor(idproveedor) {
        const subProveedores = this.subProveedores.filter(item => item.idtercero === idproveedor);
        const productos_proveedor = this.optionProducto.filter(item => item.params && item.params.tercero_id === idproveedor.toString());

        const form = new FormFormat();
        const $form = $('#orden-compra');

        // Referencia al campo del proveedor
        const $campoProveedor = $form.find('#tercero_id').closest('.form-group');

        const $subSelect = $form.find('#tercero_siesa_id').closest('.form-group');
        if ($subSelect.length) {
            $subSelect.slideUp(200, () => $subSelect.remove());
        }


        if (subProveedores.length > 0) {
            const $selectSubproveedor = $(form.agregarSelect({
                id: 'tercero_siesa_id',
                name: 'tercero_siesa_id',
                options: subProveedores ||[],
                placeholder: 'Sub proveedor',
                required: true,
                classDivName: 'col-lg-4 col-md-4 col-sm-12',
                conContenedor: true,
                conLabel: true,
            })).hide();

            // Insertar justo después del campo del proveedor
            $campoProveedor.after($selectSubproveedor);
            $selectSubproveedor.slideDown(300, () => {
                form.formatSelect(); // Aplica Chosen u otros formatos
            $("#orden-compra #compra_mes").val(form.formatMoney(0));
            $("#orden-compra #convenio_mensual").val(form.formatMoney(0));
            $("#orden-compra #orden_min_compra").val(form.formatMoney(0));
            });
            
        }else {
            this.controler = 'ordenCompra/';
            this.controlador('CompraMesTercero', {id_tercero:idproveedor}, 'POST')
                .then((r) => {
                    const { response, message, data } = r;

                    console.log('Productos del proveedor', data);
                    if (response) {
                    
                        $("#orden-compra #compra_mes").val(form.formatMoney(data[0].valor_total_compras || 0));
                        $("#orden-compra #convenio_mensual").val(form.formatMoney(data[0].valor_convenio || 0));
                        $("#orden-compra #orden_min_compra").val(form.formatMoney(data[0].valor_minimo || 0));
                    }
                    else {
                    $("#orden-compra #compra_mes").val(form.formatMoney(0));
                    $("#orden-compra #convenio_mensual").val(form.formatMoney(0));
                    $("#orden-compra #orden_min_compra").val(form.formatMoney(0));
                    }

                }).catch((e) => {
                    console.error('Error al obtener los convenios proveedor', e);
                }); 
        
        
        }
        
        const $selectProductoAnterior = $form.find('#productos').closest('.form-group');
        if ($selectProductoAnterior.length) {
            $selectProductoAnterior.slideUp(200, () => $selectProductoAnterior.remove());
        }

        const $campoConvenio = $form.find('#tipo_concepto').closest('.form-group');

        const $selectProducto = $(form.agregarSelect({
            id: 'productos',
            name: 'productos',
            options: productos_proveedor,
            placeholder: 'Productos',
            required: false,
            classDivName: 'col-lg-12 col-md-12 col-sm-12',
            conContenedor: true,
            conLabel: true,
        })).hide();

        $campoConvenio.after($selectProducto);
        $selectProducto.slideDown(300, () => {
            form.formatSelect();
        });
    }

//BR:

public function CompraMesTercero(){
    try {
      // parent::$_conexion->debug = true;
      $daq = new ordenCompraDAQ(parent::$_conexion); 
      $id_tercero = isset(parent::$_datosPeticion["id_tercero"]) ? parent::getParam("id_tercero") : '';


        
      $row = $daq->DAQConsultarComprasMesProveedor($id_tercero);
      if ($row && $row->rowCount() > 0) {
        $data=$row->GetRows();
        $row->close();
      } else {
        throw new Exception("No existe información de compras realizadas este mes.");
      }
      
      $response["data"]= $data;
      $response["response"] = true;
      parent::showResponse($response, 200);
    } catch (Exception $e) {
      $db_e = ADODB_Pear_Error();
      if ($db_e) {
        throw new Exception($db_e->message);
      }
      $response["response"] = false;
      $response["message"] = $e->getMessage();
      parent::showResponse($response, 200);
    }
  }

//DAQ:
 public function DAQConsultarComprasMesProveedor($idproveedor)
  {
    $p1 = $this->cadenaConexion->Param('idproveedor');

    $sql="SELECT
            t.id AS id,
            t.codter_b AS codter_b,
            t.nomlarg_b AS nomter_b,
            t.valmin_orden AS valor_minimo,
            t.val_convenio AS valor_convenio,	
            IFNULL(SUM(f.valfac_b),0) AS valor_total_compras
            FROM tercero t
            LEFT JOIN factcoms f ON f.tercero_id=t.id
            AND f.fecfac_b BETWEEN DATE_FORMAT('2025-01-29', '%Y-%m-01') AND LAST_DAY(CURDATE()) -- cambiar fecha a curdate()
            WHERE t.estter_b='ACTIVO'
            AND t.id=$p1
            GROUP BY t.id;";
    $bindVars = array($idproveedor); 

    $result = $this->cadenaConexion->execute($sql , $bindVars);
    return $result;
  }




events.js:
// botón para volver al formulario de filtros
        $(document).on('click', '#btn-volver', function () {
            $('.card-form').show('slide', { direction: 'up' }, 500);
            $('.card-table').hide('slide', { direction: 'up' }, 500);
            $('.title-orden').text('Orden de Compras')
        });

